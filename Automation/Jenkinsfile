pipeline {
  agent any

  tools {
    jdk 'jdk21'      // must match name in Jenkins → Global Tool Config
    maven 'M3'   // must match name in Jenkins → Global Tool Config
  }

  environment {
    MAVEN_OPTS = "-Xmx2048m"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build') {
      steps {
        script {
          if (isUnix()) {
            sh 'mvn -B -DskipTests clean package'
          } else {
            bat 'mvn -B -DskipTests clean package'
          }
        }
      }
    }

    stage('Run Tests') {
      steps {
        script {
          if (isUnix()) {
            sh 'mvn -B test'
          } else {
            bat 'mvn -B test'
          }
        }
      }

      post {
        always {
          // collect JUnit/TestNG xmls (covers common locations)
          junit '**/TEST-*.xml'

          // archive reports and cucumber json
          archiveArtifacts artifacts: 'reports/ExtentReports/*.html, test-output/**/*.html, target/cucumber-reports/*.html, target/cucumber.json', fingerprint: true
        }
      }
    }
  }
}
